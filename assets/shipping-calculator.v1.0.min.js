/**
 * Module to add a shipping rates calculator to cart page.
 *
 * Copyright (c) 2011-2014 Caroline Schnapp (11heavens.com)
 * Dual licensed under the MIT and GPL licenses:
 * http://www.opensource.org/licenses/mit-license.php
 * http://www.gnu.org/licenses/gpl.html
 *
 * v1.0
 */

if (typeof Countries === "object") {Countries.updateProvinceLabel = function (d, a) {if (typeof d === "string" && Countries[d] && Countries[d].provinces) {if (typeof a !== "object") {a = document.getElementById("address_province_label");if (a === null) {return;}}a.innerHTML = Countries[d].label;var c = jQuery(a).parent();var b = c.find("select");c.find(".custom-style-select-box-inner").html(Countries[d].provinces[0]);}};}if (typeof Shopify.Cart === "undefined") {Shopify.Cart = {};}Shopify.Cart.ShippingCalculator = function () {var _config = { submitButton: "Calculate shipping", submitButtonDisabled: "Calculating...", templateId: "shipping-calculator-response-template", wrapperId: "wrapper-response", customerIsLoggedIn: false, moneyFormat: "${{amount}}" };var _render = function _render(response) {var template = jQuery("#" + _config.templateId);var wrapper = jQuery("#" + _config.wrapperId);if (template.length && wrapper.length) {var myTemplate = _.template(jQuery.trim(template.text()));var compiled = myTemplate(response);jQuery(compiled).appendTo(wrapper);if (typeof Currency !== "undefined" && typeof Currency.convertAll === "function") {var newCurrency = "";if (jQuery("[name=currencies]").length) {newCurrency = jQuery("[name=currencies]").val();} else {if (jQuery("[name=currencies] span.selected").length) {newCurrency = jQuery("[name=currencies] span.selected").attr("data-currency");}}if (newCurrency !== "") {Currency.convertAll(shopCurrency, newCurrency, "#wrapper-response span.money, #estimated-shipping span.money");}}}};var _enableButtons = function _enableButtons() {jQuery(".get-rates").removeAttr("disabled").removeClass("disabled").val(_config.submitButton);};var _disableButtons = function _disableButtons() {jQuery(".get-rates").val(_config.submitButtonDisabled).attr("disabled", "disabled").addClass("disabled");};var _getCartShippingRatesForDestination = function _getCartShippingRatesForDestination(shipping_address) {var params = { type: "GET", url: theme.routes.cart_url + "/shipping_rates.json", data: jQuery.param({ shipping_address: shipping_address }), dataType: "json", success: function success(response) {rates = response.shipping_rates;_onCartShippingRatesUpdate(rates, shipping_address);}, error: function error(XMLHttpRequest, textStatus) {_onError(XMLHttpRequest, textStatus);} };jQuery.ajax(params);};var _fullMessagesFromErrors = function _fullMessagesFromErrors(errors) {var fullMessages = [];jQuery.each(errors, function (attribute, messages) {jQuery.each(messages, function (index, message) {fullMessages.push(attribute + " " + message);});});return fullMessages;};var _onError = function _onError(XMLHttpRequest, textStatus) {jQuery("#estimated-shipping").hide();jQuery("#estimated-shipping em").empty();_enableButtons();var feedback = "";var data = eval("(" + XMLHttpRequest.responseText + ")");if (!!data.message) {feedback = data.message + "(" + data.status + "): " + data.description;} else {feedback = "Error : " + _fullMessagesFromErrors(data).join("; ");}if (feedback === "Error : country is not supported.") {feedback = "We do not ship to this destination.";}_render({ rates: [], errorFeedback: feedback, success: false });jQuery("#" + _config.wrapperId).show();};var _onCartShippingRatesUpdate = function _onCartShippingRatesUpdate(rates, shipping_address) {_enableButtons();var readable_address = "";if (shipping_address.zip) {readable_address += shipping_address.zip + ", ";}if (shipping_address.province) {readable_address += shipping_address.province + ", ";}readable_address += shipping_address.country;if (rates.length) {if (rates[0].price == "0.00") {jQuery("#estimated-shipping em").html("FREE");} else {jQuery("#estimated-shipping em").html(_formatRate(rates[0].price));}for (var i = 0; i < rates.length; i++) {rates[i].price = _formatRate(rates[i].price);}}_render({ rates: rates, address: readable_address, success: true });jQuery("#" + _config.wrapperId + ", #estimated-shipping").fadeIn();};var _formatRate = function _formatRate(cents) {if (typeof theme.Shopify.formatMoney === "function") {return theme.Shopify.formatMoney(cents.indexOf('.') >= 0 && cents.split('.')[1].length === 3 ? cents.substr(0, cents.length - 1) : cents, _config.moneyFormat);}if (typeof cents == "string") {cents = cents.replace(".", "");}var value = "";var placeholderRegex = /\{\{\s*(\w+)\s*\}\}/;var formatString = _config.moneyFormat;function defaultOption(opt, def) {return typeof opt == "undefined" ? def : opt;}function formatWithDelimiters(number, precision, thousands, decimal) {precision = defaultOption(precision, 2);thousands = defaultOption(thousands, ",");decimal = defaultOption(decimal, ".");if (isNaN(number) || number == null) {return 0;}number = (number / 100).toFixed(precision);var parts = number.split("."),dollars = parts[0].replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "$1" + thousands),cents = parts[1] ? decimal + parts[1] : "";return dollars + cents;}switch (formatString.match(placeholderRegex)[1]) {case "amount":value = formatWithDelimiters(cents, 2);break;case "amount_no_decimals":value = formatWithDelimiters(cents, 0);break;case "amount_with_comma_separator":value = formatWithDelimiters(cents, 2, ".", ",");break;case "amount_no_decimals_with_comma_separator":value = formatWithDelimiters(cents, 0, ".", ",");break;}return formatString.replace(placeholderRegex, value);};_init = function _init() {new Shopify.CountryProvinceSelector("address_country", "address_province", { hideElement: "address_province_container" });var countriesSelect = jQuery("#address_country");var addressProvinceLabelEl = jQuery("#address_province_label").get(0);if (typeof Countries !== "undefined") {Countries.updateProvinceLabel(countriesSelect.val(), addressProvinceLabelEl);countriesSelect.change(function () {Countries.updateProvinceLabel(countriesSelect.val(), addressProvinceLabelEl);});}jQuery(".get-rates").click(function () {_disableButtons();jQuery("#" + _config.wrapperId).empty().hide();var shippingAddress = {};shippingAddress.zip = jQuery("#address_zip").val() || "";shippingAddress.country = jQuery("#address_country").val() || "";shippingAddress.province = jQuery("#address_province").val() || "";_getCartShippingRatesForDestination(shippingAddress);});if (_config.customerIsLoggedIn) {jQuery(".get-rates:eq(0)").trigger("click");}};return { show: function show(params) {params = params || {};jQuery.extend(_config, params);jQuery(function () {_init();});}, getConfig: function getConfig() {return _config;}, formatRate: function formatRate(cents) {return _formatRate(cents);} };}();